---
author: "Equipo Edumer"
format: pdf
editor: visual
---

## Analysis

### Descriptive analysis

```{r packages, echo=FALSE}
pacman::p_load(tidyverse,
               ggpubr, 
               lme4, 
               ordinal,
               sjPlot, 
               texreg,
               kableExtra)

options(scipen=999)
rm(list = ls())

```

```{r data, echo=FALSE}

load("input/data/data_index.RData")
load("input/data/deservingness.RData")
load("input/data/soc_effort.RData")
load("input/data/soc_talent.RData")
load("input/data/school_effort.RData")
load("input/data/school_talent.RData")
load("input/data/data_rec.RData")

```

```{r functions, echo=FALSE}

miles <- function(x) {
  format(round(as.numeric(x),0), big.mark = ".")
}

decimales <- function(x) {
  format(round(as.numeric(x), 2), decimal.mark = ",")
}

# set theme

#windowsFonts(`Times New Roman` = windowsFont("Times New Roman"))

theme_nice <- function() {
  theme_bw() +
    theme(text = element_text(family = "serif"))
  
  
}

theme_set(theme_nice())

```

@fig-bivariate shows a series of graphs depicting the association between the variables of market justice preferences - in education, health, and pensions - and the variables of meritocratic perception at school (effort and talent) and in society (effort, talent, and deservingness) (see conceptual diagram in @fig-hypotheses). On the left, we observe the social meritocracy diagrams, while on the right the school meritocracy diagrams are shown. For the three variables of perception of meritocracy in society the relationship is clear, since the average of market justice preferences increases the more there is agreement that people are rewarded for their effort, merit, and talent. This relationship needs to be clarified in the case of the variables of perception of meritocracy at school. To the extent that there is more agreement that the perception of talent is essential for obtaining good grades, the average of market justice preferences increases, but this relationship is not as clear as with the variables of meritocracy in society. In addition, the graph does not show a clear trend in the relationship between the perception that effort is essential to obtain good grades and market justice preferences.

```{r echo=FALSE}
#| fig-cap: "Market justice preferences in education, health and pensions by social and school meritocracy"
#| fig-asp: 1.22
#| label: fig-bivariate

plot_soc_effort <- soc_effort %>% 
  mutate(justice = str_to_title(justice)) %>% 
  ggplot(aes(x = esfuerzo_soc, y = mean)) +
  geom_point(aes(color = justice, shape = justice), size = 2) +
  scale_y_continuous(labels = decimales, limits = c(1, 4)) +
  scale_x_continuous(limits = c(1, 4),
                     breaks = seq(1, 4, by = 1),
                     label = c("Strongly\n disagree", 
                               "Disagree", 
                               "Agree", 
                               "Strongly\n agree")) +
  scale_color_grey() +
  labs(x = "Social effort",
       y = "Market justice preferences") +
  theme(legend.position = "none",
        text = element_text(size = 11))

plot_deservingness <- deservingness %>% 
  mutate(justice = str_to_title(justice)) %>% 
  ggplot(aes(x = merito_soc, y = mean)) +
  geom_point(aes(color = justice, shape = justice), size = 2) +
  scale_y_continuous(labels = decimales, limits = c(1, 4)) +
  scale_x_continuous(limits = c(1, 4),
                     breaks = seq(1, 4, by = 1),
                     label = c("Strongly\n disagree", 
                               "Disagree", 
                               "Agree", 
                               "Strongly\n agree")) +
  scale_color_grey() +
  labs(x = "Deservingness",
       y = "Market justice preferences") +
  theme(legend.position = "none",
        text = element_text(size = 11))

plot_soc_talent <- soc_talent %>% 
  mutate(justice = str_to_title(justice)) %>% 
  ggplot(aes(x = inteligencia_soc, y = mean)) +
  geom_point(aes(color = justice, shape = justice), size = 2) +
  scale_y_continuous(labels = decimales, limits = c(1, 4)) +
  scale_x_continuous(limits = c(1, 4),
                     breaks = seq(1, 4, by = 1),
                     label = c("Strongly\n disagree", 
                               "Disagree", 
                               "Agree", 
                               "Strongly\n agree")) +
  scale_color_grey() +
  labs(x = "Social talent",
       y = "Market justice preferences") +
  theme(legend.position = "none",
        text = element_text(size = 11))

plot_school_effort <- school_effort %>% 
  mutate(justice = str_to_title(justice)) %>% 
  ggplot(aes(x = esfuerzo_esc, y = mean)) +
  geom_point(aes(color = justice, shape = justice), size = 2) +
  scale_y_continuous(labels = decimales, limits = c(1, 4)) +
  scale_x_continuous(limits = c(1, 4),
                     breaks = seq(1, 4, by = 1),
                     label = c("Strongly\n disagree", 
                               "Disagree", 
                               "Agree", 
                               "Strongly\n agree")) +
  scale_color_grey() +
  labs(x = "School effort",
       y = "") +
  theme(legend.position = "none",
        text = element_text(size = 11))


plot_school_talent <- school_talent %>% 
  mutate(justice = str_to_title(justice)) %>% 
  ggplot(aes(x = inteligencia_esc, y = mean)) +
  geom_point(aes(color = justice, shape = justice), size = 2) +
  scale_y_continuous(labels = decimales, limits = c(1, 4)) +
  scale_x_continuous(limits = c(1, 4),
                     breaks = seq(1, 4, by = 1),
                     label = c("Strongly\n disagree", 
                               "Disagree", 
                               "Agree", 
                               "Strongly\n agree")) +
  scale_color_grey() +
  labs(x = "School talent",
       y = "",
       color = NULL,
       shape = NULL) +
  theme(text = element_text(size = 11))

leg <- get_legend(plot_school_talent)

plot_school_talent <- plot_school_talent + theme(legend.position = "none")

ggarrange(plot_soc_effort, plot_school_effort, plot_soc_talent,
          plot_school_talent, plot_deservingness, leg, ncol = 2, nrow = 3)
```

### Multivariate results

The results of the cumulative link mixed models for the ordinal dependent variables of justice in differential access to education, health, and pensions by income are presented in @fig-odds. This figure illustrates the effect of meritocratic variables on society and school as independent variables; however, the models incorporate all variables utilized in the study for each of the three dependent variables separately (complete models are available in the [Appendix](#appendix)).

```{r echo=FALSE}

data_pension <- data_rec %>% dplyr::select(-just_educ, -just_salud, -redistribucion)
data_pension <- na.omit(data_pension)
data_pension$just_pension_fact <- as_factor(data_pension$just_pension)
reg5_pension <- clmm(just_pension_fact ~ 1 + inteligencia_esc + esfuerzo_esc + inteligencia_soc + esfuerzo_soc + merito_soc + educacion_rec + libros_rec + acc_tec + internet_rec + mean_educ + cod_depe2 + cod_grupo + simce + (1 | mrbd), data=data_pension)
data_salud <- data_rec %>% dplyr::select(-just_pension, -just_educ, -redistribucion)
data_salud <- na.omit(data_salud)
data_salud$just_salud_fact <- as_factor(data_salud$just_salud)
reg5_salud <- clmm(just_salud_fact ~ 1 + inteligencia_esc + esfuerzo_esc + inteligencia_soc + esfuerzo_soc + merito_soc + educacion_rec + libros_rec + acc_tec + internet_rec + mean_educ + cod_depe2 + cod_grupo + simce + (1 | mrbd), data=data_salud)
data_educ <- data_rec %>% dplyr::select(-just_pension, -just_salud, -redistribucion)
data_educ <- na.omit(data_educ)
data_educ$just_educ_fact <- as_factor(data_educ$just_educ)
reg5_educ <- clmm(just_educ_fact ~ 1 + inteligencia_esc + esfuerzo_esc + inteligencia_soc + esfuerzo_soc + merito_soc + educacion_rec + libros_rec + acc_tec + internet_rec + mean_educ + cod_depe2 + cod_grupo + simce + (1 | mrbd), data=data_educ)
```

```{r echo=FALSE}
#| fig-cap: "Odds-ratios of justification of pensions, education and health by social and school meritocracy"
#| label: fig-odds
#| fig-asp: 0.8

plot_models(reg5_salud, reg5_educ, reg5_pension,  
            rm.terms = c("1|2", "2|3", "3|4", "educacion_recEd Media", "educacion_recEd Tecnica", "educacion_recUniversidad o posgrado", "educacion_recNs/Nr", "libros_recM치s de 25", "acc_tec", "internet_rec2", "internet_recNs/Nr", "mean_educ", "cod_depe2Part. subvencionado", "cod_depe2Part. privado", "cod_grupoMedio bajo", "cod_grupoMedio", "cod_grupoMedio alto", "cod_grupoAlto", "simceMedio", "simceAlto"), #quitar terminos
            title = "", #quitar titulo
            show.values = TRUE, #mostrar valor de efectos
            dot.size = 1.3, #tama침o circulos
            line.size = 1, #tama침o CI
            value.size = 3.5, #tama침o valor efectoss
            spacing = .7, #espacio entre efectos
            grid = TRUE, # separa en un plot por modelo
            vline.color = "firebrick", # linea roja en punto neutro (1)
            axis.labels = rev(c("School talent", 
                            "School effort", 
                            "Social talent",
                            "Social effort", 
                            "Deservingness"
                            )), #con rev porque automatico los tira en otro orden
            show.legend = FALSE,
            m.labels = c("Health", "Education","Pension"),
            colors = gray(level = 0.2))  # variables dependientes

```

@fig-odds demonstrates a similar trend for the three dependent variables of justice in differential access to pensions, education, and health, with all effects being statistically significant. In the context of school meritocracy, the effects are mixed: as perceived school talent increases, the justification for differentiated access to these services increases; conversely, as perceived school effort increases, the justification decreases, holding all other variables constant. Regarding the variables of social meritocracy, the three variables of talent, effort, and deservingness show that as these increase, the justification for differentiated access to pensions, education, and health also increases. Overall, these results provide partial support for our first hypothesis (H1a), which posited that students who perceive higher levels of meritocracy in school would be more likely to justify differential access to pensions, health, and education. This is evidenced by the positive effect of perceiving talent as important for achieving good grades. However, the results strongly support our second hypothesis (H1b), as a higher perception of societal meritocracy among students tends to increase the justification for market-based justice in these social services.

Contextual effects for ordinal models.

```{r echo=FALSE, include=FALSE}

reg0_bienestar <- lmer(bienestar ~ 1 + (1 | mrbd), data=data_bienestar)
reg1_bienestar <- lmer(bienestar ~ 1 + inteligencia_esc + esfuerzo_esc + inteligencia_soc + esfuerzo_soc + merito_soc + (1 | mrbd), data=data_bienestar)
reg2_bienestar <- lmer(bienestar ~ 1 + inteligencia_esc + esfuerzo_esc + inteligencia_soc + esfuerzo_soc + merito_soc + educacion_rec + libros_rec + acc_tec + internet_rec + (1 | mrbd), data=data_bienestar)
reg3_bienestar <- lmer(bienestar ~ 1 + mean_educ + cod_depe2 + cod_grupo + simce + (1 | mrbd), data=data_bienestar)
reg4_bienestar <- lmer(bienestar ~ 1 + esfuerzo_soc + merito_soc + inteligencia_soc + esfuerzo_esc + inteligencia_esc + educacion_rec + libros_rec + acc_tec + internet_rec + mean_educ + cod_depe2 + cod_grupo + simce + (1 | mrbd), data=data_bienestar)

test01<- anova(reg0_bienestar,reg1_bienestar,test = "Chisq")
test02<- anova(reg0_bienestar,reg2_bienestar,test = "Chisq")
test03<- anova(reg0_bienestar,reg3_bienestar,test = "Chisq")
test04<- anova(reg0_bienestar,reg4_bienestar,test = "Chisq")


test.pvalues1<- test01$`Pr(>Chisq)`[2]
test.pvalues2<- test02$`Pr(>Chisq)`[2]
test.pvalues3<- test03$`Pr(>Chisq)`[2]
test.pvalues4<- test04$`Pr(>Chisq)`[2]

deviance1 <- test01$deviance[2]
deviance2 <- test02$deviance[2]
deviance3 <- test03$deviance[2]
deviance4 <- test04$deviance[2]
```

```{r echo=FALSE, results='asis'}
#| tbl-cap: "Multilevel models for meritocracy perception and market justice preferences"
#| label: tbl-individual-reg

texreg::htmlreg(list(reg1_bienestar, reg2_bienestar),
        custom.model.names = c("Model 1",
                               "Model 2"),
        custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
        omit.coef = "(internet_rec)",
        caption = "",
        custom.coef.names = c("Intercept",  
                              "School talent",
                              "School effort", 
                              "Social talent",  
                              "Social effort",
                              "Deservingness",
                              "Secondary", 
                              "Higher tec.", 
                              "University or posgraduate", 
                              "Missing", 
                              "More than 25 books (Ref. Less than 25)", 
                              "Technology access"),
        groups = list("Parental education (Ref.= 8th grade or less)"=7:10),
        custom.gof.rows=list("Deviance" = c(deviance1,
                                            deviance2),
                             "Deviance Test (p)" = c(test.pvalues1,
                                                       test.pvalues2))
        )

```

Regarding our measure of market justice preferences index, the results of the multilevel linear estimation are shown in @tbl-individual-reg. The intraclass correlation obtained for the null model (not shown) it's equal to 4% (ICC based on [@hox_multilevel_2010, p.15]), which indicates that only a small percentage of the total variance of the students' market justice preferences are associated with the characteristics of schools, and therefore limits the possibilities of finding effects at this second level of analysis.

Model 1 introduces social meritocratic variables: effort (whether efforts are rewarded), deservingness (people get what they deserve), and social talent (intelligence and skills are rewarded in society). In line with our hypotheses, the perception of a meritocratic society is positively related to the justification of inequality. Model 2 shows a mixed picture: while those perceiving that talent is rewarded also justify the inequality, the perception that effort is rewarded at school is negatively related to justification of inequality. Family background variables in Model 3 reveal that education and technology access are not related to justification of inequality, whereby we observe a negative impact of family cultural capital as measured by the number of books at home. While school socio-structural variables added in Model 4 show no significant effects, average achievement scores in the SIMCE test depict a negative relationship with the dependent variable, meaning that students that attend schools with better achievement scores on average justify less inequality.

In relation to model fit, when comparing the deviance with a model without predictors (null model), all the models have a statistically significant difference, with model 5 having the lowest deviance. According to Raudenbush and Bryk's (2002) estimate of R2, the level 1 variance of model 5 is 0.11 and the level 2 variance is 0.72. The total variance of model 5 according to Snijders and Bosker (2012) is 0.14.

```{r echo=FALSE, results='asis'}
#| tbl-cap: "Contextual effects of multilevel regression models"
#| label: tbl-contextual-reg

texreg::htmlreg(list(reg3_bienestar, reg4_bienestar),
        custom.model.names = c("Model 1",
                               "Model 2"),
        custom.note = "*** p < 0.001; ** p < 0.01; * p < 0.05", 
        omit.coef = c("inteligencia_esc|esfuerzo_esc|inteligencia_soc|esfuerzo_soc|merito_soc|educacion_rec|libros_rec|acc_tec|internet_rec"),
        caption = "",
        custom.coef.names = c("Intercept", 
                              "Prop. university level at school",
                              "Subsidized private", 
                              "Private", 
                              "SES Medium low", 
                              "SES Medium", 
                              "SES Medium high", 
                              "SES High", 
                              "Simce Medium", 
                              "Simce High"),
        groups = list("Administrative dependence (Ref.= Public)"=3:4,
                      "Socioeconomic level (Ref.= Low)"=5:8,
                      "Achievement score (Ref.= Low)"=9:10),
        custom.gof.rows=list("Deviance" = c(deviance3,
                                            deviance4),
                             "Deviance Test (p)" = c(test.pvalues3,
                                                     test.pvalues4))
        )

```

```{r echo=FALSE}
#| tbl-cap: "Interactions effects"
#| label: tbl-interact

pacman::p_load(kableExtra)
load("input/data/interact.RData")
kbl(collapse_rows,
    align = "lccccc", booktabs = T,
    col.names =  c("Variable", 
                   "School talent", 
                   "School effort",
                   "Social talent",
                   "Social effort", 
                   "Deservingness")) %>%
  add_header_above(c(" " = 1,
                     "Market Justice Preferences"=5), 
                   bold = T)%>%  
  kable_styling(latex_options = c("scale_down","HOLD_position"),
                full_width = F) %>%
  column_spec(1, bold = T, width = "4cm") %>%
  column_spec(column = 2:6,width = "1.5cm") %>%
  collapse_rows(columns = 1:2, valign = "middle") %>% 
  footnote(general = "***p < 0.001, **p < 0.01, *p < 0.05",
           footnote_as_chunk = T,general_title = "Note: ")

```

The interaction terms in @tbl-interact suggest that students' family background moderates the relationship between their meritocratic perceptions in Chile and their justification of inequality. The direction of these effects confirms our initial prediction. Thus, in line with our Hypothesis 3, the relationship between social effort and justification of inequality becomes less positive for those students whose parents achieved university or postgraduate education. That is, lower-status students (measured by parental education) justify more inequality when they adhere more strongly to deservingnessmeritocratic perceptions in Chile. This result confirms the enlightenment thesis (see above). The same moderating effect is observed for students' family cultural capital: the relationship between effort (but not deservingness nor social talent) and justification of inequality becomes less positive for students with more than 25 books at home. Interestingly, family cultural capital also moderates the relationship between meritocratic beliefs at school (as measured by students' belief that effort is important to get good grades) and justification of inequality.

At the school level, we also observe moderating effects of school status and students' meritocratic beliefs over their justification of inequality. Thus, in line with our Hypothesis 5, high-status schools justify less inequality when, on average, their students have a greater perception of meritocracy in Chile, as measured by the three indicators we used (i.e., effort, deservingness, and talent). Finally, as we stated in Hypothesis 7, low-achieving schools justify more inequality when their students have, on average, stronger meritocratic beliefs in Chile. In @fig-interaction we depict this moderating effect of school achievement for the relationship between deservingness and justification of inequality. We did not observe these moderating effects at the school level for students' meritocratic beliefs in the school (i.e., the idea that effort or talent are important to get good grades).

```{r echo=FALSE, include=FALSE}
load("input/data/data_rec.RData")
data_rec <- data_rec %>% rowwise() %>%  mutate(educacion_rec2 = case_when(educacion_rec=="Ed Basica"~"Low level",
                                                 educacion_rec=="Ed Media"~"Low level",
                                                 educacion_rec=="Ed Tecnica"~"Low level",
                                                 educacion_rec=="Universidad o posgrado"~"University or Postgraduate",
                                                 educacion_rec=="Ns/Nr"~"Missing"
                                                 ))
data_rec$educacion_rec2 <- factor(data_rec$educacion_rec2, levels = c("Low level", "University or Postgraduate", "Missing"))


data_rec <- data_rec %>% rowwise() %>%  mutate(cod_grupo2  = case_when(cod_grupo=="Bajo"~"Bajo",
                                                                       cod_grupo=="Medio bajo"~"Bajo",
                                                                       cod_grupo=="Medio"~"Bajo",
                                                                       cod_grupo=="Medio alto"~"Alto",
                                                                       cod_grupo=="Alto"~"Alto"))
data_rec$cod_grupo2 <- factor(data_rec$cod_grupo2, levels = c("Bajo", "Alto"))
data_rec$simce <- factor(data_rec$simce, labels = c("Low", "Medium", "High"))


data_bienestar <- na.omit(data_rec)
#data_bienestar <- data_bienestar %>% mutate(pension_rec = 5-just_pension,
#                                            educ_rec = 5-just_educ,
#                                            salud_rec = 5-just_salud)
data_bienestar <- data_bienestar %>% rowwise() %>% dplyr::mutate(bienestar = mean(c(just_educ, just_salud, just_pension), na.omit=TRUE))
data_bienestar$bienestar <- round(data_bienestar$bienestar, 2)

reg26.2_bienestar <- lmer(bienestar ~ 1 + esfuerzo_soc + inteligencia_soc + esfuerzo_esc + inteligencia_esc + educacion_rec2 + libros_rec + acc_tec + mean_educ + cod_depe2 + cod_grupo2 + merito_soc*simce + internet_rec + (1 + simce | mrbd), data=data_bienestar)

plot_interact<- plot_model(reg26.2_bienestar, type = "int", mdrt.values="minmax", title = "", colors = c("red", "white", "blue")) +
  ylim(1,4)+
  labs(x = "Deservingness", y="Market Justice Preferences", colour = "School Simce")+
  theme_bw()
```

```{r echo=FALSE, warning=FALSE}
#| fig-cap: "Interaction between deservingness and justification of inequality by school SIMCE achievement"
#| label: fig-interaction

plot_interact

```
